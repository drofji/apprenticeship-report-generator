<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apprenticeship Report Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f3f2ef;
  color: #191919;
  min-height: 100vh;
  font-size: 14px;
  line-height: 1.5;
  display: flex;
  flex-direction: column;
}
.layout { display: flex; flex: 1; }
.sidebar {
  width: 240px; background: #ffffff; border-right: 1px solid #e0dfdc;
  position: fixed; top: 0; left: 0; bottom: 0; overflow-y: auto; z-index: 100;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.sidebar-logo { padding: 20px 16px 16px; border-bottom: 1px solid #e0dfdc; background: #0a66c2; }
.sidebar-logo h1 { font-size: 18px; font-weight: 700; color: #ffffff; letter-spacing: -0.3px; }
.sidebar-logo p { font-size: 11px; color: rgba(255,255,255,0.75); margin-top: 2px; }
.nav-section { padding: 8px 0; border-bottom: 1px solid #e0dfdc; }
.nav-section-title { font-size: 11px; font-weight: 600; color: #666666; text-transform: uppercase; letter-spacing: 0.8px; padding: 8px 16px 4px; }
.nav-item {
  display: flex; align-items: center; gap: 10px; padding: 10px 16px; cursor: pointer;
  font-size: 13px; font-weight: 500; color: #444444; border-left: 3px solid transparent;
  transition: all 0.15s; text-decoration: none;
}
.nav-item:hover { background: #f3f2ef; color: #0a66c2; }
.nav-item.active { background: #eef3fb; color: #0a66c2; border-left-color: #0a66c2; font-weight: 600; }
.nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }
.main { margin-left: 240px; flex: 1; padding: 24px 24px 0; max-width: calc(100% - 240px); }
.card {
  background: #ffffff; border: 1px solid #e0dfdc; border-radius: 8px;
  padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.card-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 18px; padding-bottom: 14px; border-bottom: 1px solid #f0efec;
}
.card-title { font-size: 16px; font-weight: 700; color: #191919; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group.full { grid-column: 1 / -1; }
label { font-size: 12px; font-weight: 600; color: #444444; text-transform: uppercase; letter-spacing: 0.5px; }
input, textarea, select {
  border: 1px solid #d0cfc9; border-radius: 6px; padding: 9px 12px;
  font-size: 14px; font-family: inherit; color: #191919; background: #ffffff;
  transition: border-color 0.15s, box-shadow 0.15s; outline: none;
}
input:focus, textarea:focus, select:focus { border-color: #0a66c2; box-shadow: 0 0 0 3px rgba(10,102,194,0.12); }
textarea { resize: vertical; min-height: 80px; }
.btn {
  display: inline-flex; align-items: center; gap: 7px; padding: 9px 18px;
  border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer;
  border: none; transition: all 0.15s; text-decoration: none;
}
.btn-primary { background: #0a66c2; color: #ffffff; }
.btn-primary:hover { background: #004182; }
.btn-secondary { background: transparent; color: #0a66c2; border: 1.5px solid #0a66c2; }
.btn-secondary:hover { background: #eef3fb; }
.btn-ghost { background: transparent; color: #666666; border: 1.5px solid #d0cfc9; }
.btn-ghost:hover { background: #f3f2ef; color: #191919; }
.btn-danger { background: transparent; color: #cc1016; border: 1.5px solid #cc1016; }
.btn-danger:hover { background: #fef2f2; }
.btn-sm { padding: 6px 14px; font-size: 12px; border-radius: 16px; }
.page { display: none; }
.page.active { display: block; }
.page-title { font-size: 22px; font-weight: 700; color: #191919; margin-bottom: 4px; }
.page-subtitle { font-size: 13px; color: #666666; margin-bottom: 20px; }
.week-item {
  background: #ffffff; border: 1px solid #e0dfdc; border-radius: 8px; padding: 16px;
  margin-bottom: 10px; cursor: pointer; transition: all 0.15s;
  display: flex; align-items: center; justify-content: space-between;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.week-item:hover { border-color: #0a66c2; box-shadow: 0 2px 8px rgba(10,102,194,0.12); }
.week-item-left { display: flex; align-items: center; gap: 14px; }
.week-badge { background: #eef3fb; color: #0a66c2; font-size: 12px; font-weight: 700; padding: 6px 12px; border-radius: 20px; white-space: nowrap; }
.week-item-title { font-size: 14px; font-weight: 600; color: #191919; }
.week-item-meta { font-size: 12px; color: #666666; margin-top: 2px; }
.week-item-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; }
.tag { font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 10px; }
.tag-office { background: #e7f3ff; color: #0a66c2; }
.tag-home { background: #e6f4ea; color: #057642; }
.tag-school { background: #fff8e1; color: #b7791f; }
.tag-sick { background: #fce8e8; color: #cc1016; }
.tag-vacation { background: #f0e6ff; color: #7c3aed; }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
.modal-overlay.open { display: flex; }
.modal { background: #ffffff; border-radius: 10px; width: 100%; max-width: 640px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 40px rgba(0,0,0,0.18); }
.modal-header { padding: 20px 24px 16px; border-bottom: 1px solid #e0dfdc; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: #ffffff; z-index: 1; }
.modal-title { font-size: 17px; font-weight: 700; color: #191919; }
.modal-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666666; font-size: 18px; transition: background 0.15s; }
.modal-close:hover { background: #f3f2ef; }
.modal-body { padding: 20px 24px; }
.modal-footer { padding: 16px 24px; border-top: 1px solid #e0dfdc; display: flex; gap: 10px; justify-content: flex-end; }
.days-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 4px; }
.day-input-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.day-input-group label { font-size: 11px; text-align: center; text-transform: none; letter-spacing: 0; color: #444444; font-weight: 500; }
.day-input-group input { width: 100%; text-align: center; padding: 8px 4px; }
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
.stat-card { background: #ffffff; border: 1px solid #e0dfdc; border-radius: 8px; padding: 16px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.stat-value { font-size: 26px; font-weight: 700; color: #0a66c2; }
.stat-label { font-size: 11px; color: #666666; margin-top: 2px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
.profile-summary { background: #ffffff; border: 1px solid #e0dfdc; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.profile-avatar { width: 60px; height: 60px; border-radius: 50%; background: #0a66c2; display: flex; align-items: center; justify-content: center; color: #ffffff; font-size: 22px; font-weight: 700; flex-shrink: 0; }
.profile-info h2 { font-size: 18px; font-weight: 700; color: #191919; }
.profile-info p { font-size: 13px; color: #555555; margin-top: 2px; }
.empty-state { text-align: center; padding: 48px 20px; color: #888888; }
.empty-state svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.4; }
.empty-state p { font-size: 14px; margin-bottom: 16px; }
.search-bar { position: relative; margin-bottom: 16px; }
.search-bar input { width: 100%; padding-left: 36px; border-radius: 20px; }
.search-bar svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888888; width: 16px; height: 16px; }
/* Mode cards */
.mode-cards { display: flex; gap: 12px; margin-bottom: 16px; }
.mode-card { flex: 1; border: 2px solid #d0cfc9; border-radius: 8px; padding: 16px; cursor: pointer; background: #ffffff; transition: all 0.15s; }
.mode-card.active { border-color: #0a66c2; background: #eef3fb; }
.mode-card-icon { font-size: 22px; margin-bottom: 6px; }
.mode-card-title { font-size: 14px; font-weight: 700; color: #444444; margin-bottom: 3px; }
.mode-card.active .mode-card-title { color: #0a66c2; }
.mode-card-desc { font-size: 12px; color: #666666; line-height: 1.5; }
/* Footer */
.app-footer {
  margin-left: 240px; background: #ffffff; border-top: 1px solid #e0dfdc;
  padding: 14px 24px; display: flex; align-items: center; justify-content: center;
}
.app-footer a {
  display: flex; align-items: center; gap: 8px; text-decoration: none;
  color: #444444; font-size: 12px; font-weight: 500; transition: color 0.15s;
}
.app-footer a:hover { color: #191919; }
.app-footer svg { width: 18px; height: 18px; }
.app-footer .sep { margin: 0 8px; color: #c0bdb5; }
/* Toast */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.progress-toast {
  background: #191919; color: #ffffff; padding: 14px 18px; border-radius: 8px; font-size: 13px;
  font-weight: 500; box-shadow: 0 4px 16px rgba(0,0,0,0.2); min-width: 240px;
  animation: slideIn 0.2s ease;
}
.progress-toast-title { margin-bottom: 6px; display:flex; align-items:center; gap:8px; }
.progress-toast-bar-wrap { background: rgba(255,255,255,0.2); border-radius:10px; height:5px; overflow:hidden; }
.progress-toast-bar { height:5px; background:#4caf8f; border-radius:10px; transition:width 0.25s ease; }
.toast { background: #191919; color: #ffffff; padding: 12px 18px; border-radius: 8px; font-size: 13px; font-weight: 500; box-shadow: 0 4px 16px rgba(0,0,0,0.2); animation: slideIn 0.2s ease; min-width: 200px; }
.toast.success { background: #057642; }
.toast.error { background: #cc1016; }
@keyframes slideIn { from { transform: translateX(60px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
/* Confirm */
.confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
.confirm-overlay.open { display: flex; }
.confirm-box { background: #ffffff; border-radius: 10px; padding: 28px; max-width: 380px; width: 90%; box-shadow: 0 8px 40px rgba(0,0,0,0.18); text-align: center; }
.confirm-icon { font-size: 32px; margin-bottom: 12px; }
.confirm-title { font-size: 17px; font-weight: 700; color: #191919; margin-bottom: 8px; }
.confirm-text { font-size: 13px; color: #555555; margin-bottom: 20px; line-height: 1.5; }
.confirm-btns { display: flex; gap: 10px; justify-content: center; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #f3f2ef; }
::-webkit-scrollbar-thumb { background: #c0bdb5; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #999999; }
@media (max-width: 768px) {
  .sidebar { width: 100%; position: relative; height: auto; }
  .main, .app-footer { margin-left: 0; max-width: 100%; }
  .layout { flex-direction: column; }
  .form-grid, .form-grid-3 { grid-template-columns: 1fr; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .days-row { grid-template-columns: repeat(3, 1fr); }
  .mode-cards { flex-direction: column; }
}
</style>
</head>
<body>

<div id="app" style="display:flex;flex-direction:column;flex:1;">
<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h1>&#x1F4CB; Berichtsheft</h1>
      <p>Ausbildungsnachweis Generator</p>
    </div>
    <nav>
      <div class="nav-section">
        <div class="nav-section-title">Navigation</div>
        <a class="nav-item active" onclick="showPage('dashboard')" data-page="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          √úbersicht
        </a>
        <a class="nav-item" onclick="showPage('profile')" data-page="profile">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          Stammdaten
        </a>
        <a class="nav-item" onclick="showPage('entries')" data-page="entries">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Berichte
        </a>
        <a class="nav-item" onclick="showPage('print')" data-page="print">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          PDF Export
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Daten</div>
        <a class="nav-item" onclick="exportData()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Exportieren (JSON)
        </a>
        <a class="nav-item" onclick="document.getElementById('importFile').click()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Importieren (JSON)
        </a>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
      </div>
    </nav>
  </aside>

  <main class="main">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <p class="page-title">√úbersicht</p>
      <p class="page-subtitle">Willkommen in Ihrem Berichtsheft-System</p>
      <div id="profileSummary" class="profile-summary" style="display:none">
        <div class="profile-avatar" id="avatarInitials">AW</div>
        <div class="profile-info"><h2 id="summaryName">‚Äì</h2><p id="summaryDetails">‚Äì</p></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;">
        <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Berichte gesamt</div></div>
        <div class="stat-card"><div class="stat-value" id="statOffice">0</div><div class="stat-label">Tage Betrieb</div></div>
        <div class="stat-card"><div class="stat-value" id="statHome">0</div><div class="stat-label">Tage Homeoffice</div></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-value" id="statSchool">0</div><div class="stat-label">Tage Schule</div></div>
        <div class="stat-card"><div class="stat-value" id="statAvgWork">&mdash;</div><div class="stat-label">&Oslash; Std./Tag Arbeit</div></div>
        <div class="stat-card"><div class="stat-value" id="statAvgSchool">&mdash;</div><div class="stat-label">&Oslash; Std./Tag Schule</div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Letzte Eintr√§ge</span>
          <button class="btn btn-primary btn-sm" onclick="showPage('entries')">Alle anzeigen</button>
        </div>
        <div id="recentEntries"></div>
      </div>
    </div>

    <!-- PROFIL -->
    <div id="page-profile" class="page">
      <p class="page-title">Stammdaten</p>
      <p class="page-subtitle">Ihre pers√∂nlichen Angaben zur Ausbildung</p>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Pers√∂nliche Daten</span>
          <button class="btn btn-primary" onclick="saveProfile()">Speichern</button>
        </div>
        <div class="form-grid">
          <div class="form-group"><label>Vorname Auszubildende/r</label><input type="text" id="pFirstName" placeholder="z.B. Alexander"></div>
          <div class="form-group"><label>Nachname Auszubildende/r</label><input type="text" id="pLastName" placeholder="z.B. Wiese"></div>
          <div class="form-group"><label>Geburtsdatum</label><input type="date" id="pBirthdate"></div>
          <div class="form-group"><label>Ausbildungsberuf</label><input type="text" id="pProfession" placeholder="z.B. Fachinformatiker/in"></div>
          <div class="form-group full"><label>Ausbildungsbetrieb / Unternehmen</label><input type="text" id="pCompany" placeholder="z.B. Muster GmbH"></div>
          <div class="form-group"><label>Name Ausbilder/in</label><input type="text" id="pAusbilder" placeholder="z.B. Max Mustermann"></div>
          <div class="form-group"><label>Ausbildungsbeginn</label><input type="date" id="pStartDate"></div>
          <div class="form-group"><label>Ausbildungsende (voraussichtlich)</label><input type="date" id="pEndDate"></div>
          <div class="form-group"><label>W√∂chentliche Soll-Stunden</label><input type="number" id="pWeeklyHours" value="40" min="1" max="60"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Best√§tigungstext (Vorschau)</span></div>
        <div style="font-size:13px;color:#333;line-height:1.7;padding:14px;background:#f8f7f5;border-radius:6px;border-left:3px solid #0a66c2;">
          Hiermit best√§tigen wir, dass <strong id="confirmNamePreview">Alexander Wiese</strong> die gem√§√ü ¬ß 43 Berufsbildungsgesetz erforderlichen Ausbildungsnachweise eigenh√§ndig, ohne fremde Hilfe und vollst√§ndig erstellt hat. Diese Erkl√§rung dient der Vorlage beim zust√§ndigen Pr√ºfungsausschuss.
        </div>
      </div>
    </div>

    <!-- BERICHTE -->
    <div id="page-entries" class="page">
      <p class="page-title">Ausbildungsnachweise</p>
      <p class="page-subtitle">W√∂chentliche Berichte verwalten</p>
      <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="openEntryModal(null)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Neuer Bericht
        </button>
        <button class="btn btn-ghost" onclick="autoFillKW()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Aktuelle KW
        </button>
      </div>
      <div class="search-bar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="searchInput" placeholder="Berichte durchsuchen..." oninput="renderEntries()">
      </div>
      <div id="entriesContainer"></div>
    </div>

    <!-- PDF EXPORT -->
    <div id="page-print" class="page">
      <p class="page-title">PDF Export</p>
      <p class="page-subtitle">Berichte als PDF herunterladen</p>

      <!-- Mode selector -->
      <div class="mode-cards">
        <div class="mode-card active" id="modeCardFull" onclick="setPrintMode('full')">
          <div class="mode-card-icon">&#x1F4C4;</div>
          <div class="mode-card-title">Detailliert ‚Äî 1 Bericht pro Seite</div>
          <div class="mode-card-desc">Vollst√§ndiges A4-Formular mit T√§tigkeitsbeschreibung, Anwesenheitstabelle, ¬ß 43 BBiG-Best√§tigung und Unterschriftsfeldern. F√ºr die offizielle Abgabe beim Pr√ºfungsausschuss.</div>
        </div>
        <div class="mode-card" id="modeCardCompact" onclick="setPrintMode('compact')">
          <div class="mode-card-icon">&#x1F4CA;</div>
          <div class="mode-card-title">Kompakt ‚Äî Offiziell &amp; platzsparend</div>
          <div class="mode-card-desc">Mehrere Wochen pro Seite ‚Äî mit vollst√§ndiger Beschreibung, ¬ß 43 BBiG-Best√§tigung und Unterschriftsfeldern. Geeignet als offizieller Abgabenachweis beim Pr√ºfungsausschuss.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title" id="printCardTitle">Detailliert ‚Äî Optionen</span></div>

        <div class="form-grid-3">
          <div class="form-group"><label>Von KW</label><input type="number" id="printFrom" min="1" max="53" placeholder="z.B. 1"></div>
          <div class="form-group"><label>Bis KW</label><input type="number" id="printTo" min="1" max="53" placeholder="z.B. 52"></div>
          <div class="form-group"><label>Jahr (optional)</label><input type="number" id="printYear" placeholder="z.B. 2024"></div>
        </div>

        <div id="compactOptions" style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid #f0efec;">
          <div class="form-group">
            <label>Wochen pro Seite <span style="font-size:11px;color:#666;text-transform:none;">(mehr = kompakter, aber vollst√§ndige Texte)</span></label>
            <select id="weeksPerPage">
              <option value="2">2 Wochen</option>
              <option value="3">3 Wochen</option>
              <option value="4">4 Wochen (ca. 1 Monat)</option>
              <option value="5">5 Wochen</option>
              <option value="6" selected>6 Wochen</option>
              <option value="7">7 Wochen</option>
              <option value="8">8 Wochen (ca. 2 Monate)</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="printReports(false)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Alle Berichte exportieren
          </button>
          <button class="btn btn-secondary" onclick="printReports(true)">Gefiltert exportieren</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Hinweis</span></div>
        <div id="printHintFull" style="font-size:13px;color:#444;line-height:1.6;">
          Jeder Bericht wird auf einer eigenen A4-Seite ausgegeben. Der Best√§tigungstext gem√§√ü ¬ß 43 BBiG sowie Unterschriftsfelder f√ºr Sie und Ihren Ausbilder sind auf jedem Blatt enthalten. <strong>Geeignet f√ºr die offizielle Abgabe beim Pr√ºfungsausschuss.</strong>
        </div>
        <div id="printHintCompact" style="display:none;font-size:13px;color:#444;line-height:1.6;">
          Mehrere Wochen pro Seite ‚Äî mit vollst√§ndiger Beschreibung, ¬ß 43 BBiG-Best√§tigung und Unterschriftsfeldern. <strong>Geeignet als offizieller Abgabenachweis beim Pr√ºfungsausschuss.</strong>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Footer -->
<footer class="app-footer">
  <a href="https://github.com/drofji/apprenticeship-report-generator" target="_blank" rel="noopener">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.604-3.369-1.342-3.369-1.342-.454-1.154-1.11-1.461-1.11-1.461-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0 1 12 6.836a9.59 9.59 0 0 1 2.504.337c1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.163 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
    <span style="font-weight:600;">drofji/apprenticeship-report-generator</span>
    <span class="sep">¬∑</span>
    <span>¬© 2026</span>
  </a>
</footer>
</div>


<!-- Progress Modal -->
<div id="pdfProgressModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:3000;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;padding:32px 36px;max-width:440px;width:92%;box-shadow:0 8px 40px rgba(0,0,0,0.22);text-align:center;">
    <div style="font-size:28px;margin-bottom:12px;">üìÑ</div>
    <div style="font-size:17px;font-weight:700;color:#191919;margin-bottom:6px;" id="pdfModalTitle">PDF wird erstellt‚Ä¶</div>
    <div style="font-size:13px;color:#666;margin-bottom:18px;" id="pdfModalStatus">Seite 1 von ‚Ä¶</div>
    <div style="background:#f0efec;border-radius:20px;height:10px;width:100%;margin-bottom:22px;overflow:hidden;">
      <div id="pdfProgressBar" style="height:10px;width:0%;background:#0a66c2;border-radius:20px;transition:width 0.2s ease;"></div>
    </div>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button class="btn btn-ghost" onclick="pdfMinimize()" style="font-size:13px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
        In den Hintergrund
      </button>
      <button class="btn btn-danger btn-sm" onclick="pdfAbort()" style="font-size:13px;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        Abbrechen
      </button>
    </div>
  </div>
</div>
<!-- Print Container -->
<div id="printContainer" style="display:none;"></div>

<!-- Modal: Bericht bearbeiten -->
<div class="modal-overlay" id="entryModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modalTitle">Neuer Bericht</span>
      <button class="modal-close" onclick="closeEntryModal()">&#x2715;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Kalenderwoche</label><input type="number" id="eKW" min="1" max="53" placeholder="z.B. 42" oninput="onKWOrYearChange()"></div>
        <div class="form-group"><label>Jahr</label><input type="number" id="eYear" placeholder="z.B. 2024" oninput="onKWOrYearChange()"></div>
        <div class="form-group"><label>Datum von (Mo)</label><input type="date" id="eFrom" onchange="onDateFromChange()"></div>
        <div class="form-group"><label>Datum bis (Fr)</label><input type="date" id="eTo" onchange="onDateToChange()"></div>
        <div class="form-group full"><label>T√§tigkeiten / Beschreibung</label><textarea id="eDescription" rows="5" placeholder="Beschreiben Sie Ihre T√§tigkeiten dieser Woche..."></textarea></div>
      </div>

      <!-- Hours section -->
      <div style="margin-top:16px;padding:14px;background:#f8f7f5;border-radius:8px;border:1px solid #e8e6e0;">
        <label style="font-size:12px;font-weight:600;color:#444;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:12px;">&#x23F1; Stunden</label>
        <div class="form-grid">
          <div class="form-group">
            <label>Stunden im Betrieb / Homeoffice <span style="color:#cc1016;">*</span></label>
            <input type="number" id="eHoursBetrieb" min="0" max="80" step="0.5" placeholder="z.B. 40" oninput="recalcTotalHours()">
          </div>
          <div class="form-group">
            <label>Stunden in der Schule <span style="font-size:11px;color:#888;text-transform:none;letter-spacing:0;">(optional)</span></label>
            <input type="number" id="eHoursSchool" min="0" max="40" step="0.5" placeholder="z.B. 0" oninput="recalcTotalHours()">
          </div>
          <div class="form-group full">
            <label>Stunden gesamt (Woche) <span style="font-size:11px;color:#0a66c2;text-transform:none;letter-spacing:0;">‚Äî wird automatisch berechnet</span></label>
            <input type="number" id="eHours" min="0" max="80" step="0.5" placeholder="‚Äî" style="background:#f0efec;color:#555;" readonly>
          </div>
        </div>
      </div>

      <!-- Days section -->
      <div style="margin-top:14px;">
        <label style="font-size:12px;font-weight:600;color:#444444;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:10px;">&#x1F4C5; Anwesenheit (in Tagen)</label>
        <div class="days-row">
          <div class="day-input-group"><label>&#x1F3E2; Betrieb</label><input type="number" id="eDaysBetrieb" min="0" max="5" step="0.5" value="0"></div>
          <div class="day-input-group"><label>&#x1F3E0; Homeoffice</label><input type="number" id="eDaysHome" min="0" max="5" step="0.5" value="0"></div>
          <div class="day-input-group"><label>&#x1F393; Schule</label><input type="number" id="eDaysSchool" min="0" max="5" step="0.5" value="0"></div>
          <div class="day-input-group"><label>&#x1F912; Krank</label><input type="number" id="eDaysSick" min="0" max="5" step="0.5" value="0"></div>
          <div class="day-input-group"><label>&#x1F334; Urlaub</label><input type="number" id="eDaysVacation" min="0" max="5" step="0.5" value="0"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeEntryModal()">Abbrechen</button>
      <button class="btn btn-danger btn-sm" id="deleteEntryBtn" onclick="deleteCurrentEntry()" style="display:none">L√∂schen</button>
      <button class="btn btn-primary" onclick="saveEntry()">Speichern</button>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon" id="confirmIcon">&#x26A0;&#xFE0F;</div>
    <div class="confirm-title" id="confirmTitle">Sind Sie sicher?</div>
    <div class="confirm-text" id="confirmText">Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.</div>
    <div class="confirm-btns">
      <button class="btn btn-ghost" onclick="resolveConfirm(false)">Abbrechen</button>
      <button class="btn btn-danger" id="confirmOkBtn" onclick="resolveConfirm(true)">Ja, fortfahren</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ===== IndexedDB =====
let db;
function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('berichtsheft_v1', 1);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('profile')) d.createObjectStore('profile', { keyPath: 'id' });
      if (!d.objectStoreNames.contains('entries')) d.createObjectStore('entries', { keyPath: 'id', autoIncrement: true });
    };
    req.onsuccess = e => { db = e.target.result; resolve(); };
    req.onerror = () => reject(req.error);
  });
}
function dbGet(store, key) {
  return new Promise((res, rej) => { const r = db.transaction(store).objectStore(store).get(key); r.onsuccess = () => res(r.result || null); r.onerror = () => rej(r.error); });
}
function dbGetAll(store) {
  return new Promise((res, rej) => { const r = db.transaction(store).objectStore(store).getAll(); r.onsuccess = () => res(r.result || []); r.onerror = () => rej(r.error); });
}
function dbPut(store, data) {
  return new Promise((res, rej) => { const r = db.transaction(store,'readwrite').objectStore(store).put(data); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); });
}
function dbDelete(store, key) {
  return new Promise((res, rej) => { const r = db.transaction(store,'readwrite').objectStore(store).delete(key); r.onsuccess = () => res(); r.onerror = () => rej(r.error); });
}
function dbClear(store) {
  return new Promise((res, rej) => { const r = db.transaction(store,'readwrite').objectStore(store).clear(); r.onsuccess = () => res(); r.onerror = () => rej(r.error); });
}

// ===== State =====
let profile = {};
let currentEditId = null;
let confirmCallback = null;
let currentPrintMode = 'full';

// ===== Navigation =====
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const nav = document.querySelector('[data-page="' + name + '"]');
  if (nav) nav.classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'entries') renderEntries();
  if (name === 'profile') loadProfileForm();
  if (name === 'print') document.getElementById('printYear').value = new Date().getFullYear();
}

// ===== Print Mode =====
function setPrintMode(mode) {
  currentPrintMode = mode;
  document.getElementById('modeCardFull').classList.toggle('active', mode === 'full');
  document.getElementById('modeCardCompact').classList.toggle('active', mode === 'compact');
  document.getElementById('compactOptions').style.display = mode === 'compact' ? 'block' : 'none';
  document.getElementById('printCardTitle').textContent = mode === 'full' ? 'Detailliert ‚Äî Optionen' : 'Kompakt ‚Äî Optionen';
  document.getElementById('printHintFull').style.display = mode === 'full' ? 'block' : 'none';
  document.getElementById('printHintCompact').style.display = mode === 'compact' ? 'block' : 'none';
}

// ===== Toast =====
function toast(msg, type) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast' + (type ? ' ' + type : '');
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3200);
}

// ===== Confirm =====
function showConfirm(title, text, icon, okLabel, okClass) {
  return new Promise(resolve => {
    confirmCallback = resolve;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmText').textContent = text;
    document.getElementById('confirmIcon').textContent = icon || '‚ö†Ô∏è';
    const btn = document.getElementById('confirmOkBtn');
    btn.textContent = okLabel || 'Ja, fortfahren';
    btn.className = 'btn ' + (okClass || 'btn-danger');
    document.getElementById('confirmOverlay').classList.add('open');
  });
}
function resolveConfirm(val) {
  document.getElementById('confirmOverlay').classList.remove('open');
  if (confirmCallback) { confirmCallback(val); confirmCallback = null; }
}

// ===== Helpers =====
function fmtDate(d) {
  if (!d) return '';
  const p = d.split('-');
  return p.length === 3 ? p[2] + '.' + p[1] + '.' + p[0] : d;
}
function toInputDate(d) {
  return d.getUTCFullYear() + '-' + String(d.getUTCMonth()+1).padStart(2,'0') + '-' + String(d.getUTCDate()).padStart(2,'0');
}
function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
  const y = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - y) / 86400000) + 1) / 7);
}
function getISOWeekYear(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
  return d.getUTCFullYear();
}
function getMondayOfKW(kw, year) {
  const jan4 = new Date(Date.UTC(year, 0, 4));
  const dow = jan4.getUTCDay() || 7;
  const monday = new Date(jan4);
  monday.setUTCDate(jan4.getUTCDate() - (dow - 1) + (kw - 1) * 7);
  return monday;
}

// ===== KW <-> Date sync =====
let _syncLock = false;
function onKWOrYearChange() {
  if (_syncLock) return;
  const kw = parseInt(document.getElementById('eKW').value);
  const year = parseInt(document.getElementById('eYear').value);
  if (!kw || kw < 1 || kw > 53 || !year || year < 2000) return;
  _syncLock = true;
  const monday = getMondayOfKW(kw, year);
  const friday = new Date(monday); friday.setUTCDate(friday.getUTCDate() + 4);
  document.getElementById('eFrom').value = toInputDate(monday);
  document.getElementById('eTo').value = toInputDate(friday);
  _syncLock = false;
}
function onDateFromChange() {
  if (_syncLock) return;
  const val = document.getElementById('eFrom').value;
  if (!val) return;
  _syncLock = true;
  const d = new Date(val + 'T00:00:00');
  const kw = getISOWeek(d); const year = getISOWeekYear(d);
  document.getElementById('eKW').value = kw;
  document.getElementById('eYear').value = year;
  const monday = getMondayOfKW(kw, year);
  const friday = new Date(monday); friday.setUTCDate(friday.getUTCDate() + 4);
  document.getElementById('eTo').value = toInputDate(friday);
  _syncLock = false;
}
function onDateToChange() {
  if (_syncLock) return;
  const val = document.getElementById('eTo').value;
  if (!val) return;
  _syncLock = true;
  const d = new Date(val + 'T00:00:00');
  const kw = getISOWeek(d); const year = getISOWeekYear(d);
  document.getElementById('eKW').value = kw;
  document.getElementById('eYear').value = year;
  if (!document.getElementById('eFrom').value) {
    document.getElementById('eFrom').value = toInputDate(getMondayOfKW(kw, year));
  }
  _syncLock = false;
}

// ===== Profile =====
async function loadProfileForm() {
  profile = (await dbGet('profile', 'main')) || {};
  document.getElementById('pFirstName').value = profile.firstName || '';
  document.getElementById('pLastName').value = profile.lastName || '';
  document.getElementById('pBirthdate').value = profile.birthdate || '';
  document.getElementById('pProfession').value = profile.profession || '';
  document.getElementById('pCompany').value = profile.company || '';
  document.getElementById('pAusbilder').value = profile.ausbilder || '';
  document.getElementById('pStartDate').value = profile.startDate || '';
  document.getElementById('pEndDate').value = profile.endDate || '';
  document.getElementById('pWeeklyHours').value = profile.weeklyHours || 40;
  updateConfirmPreview();
}
function updateConfirmPreview() {
  const fn = document.getElementById('pFirstName').value;
  const ln = document.getElementById('pLastName').value;
  document.getElementById('confirmNamePreview').textContent = (fn + ' ' + ln).trim() || 'Alexander Wiese';
}
document.getElementById('pFirstName').addEventListener('input', updateConfirmPreview);
document.getElementById('pLastName').addEventListener('input', updateConfirmPreview);
async function saveProfile() {
  const data = {
    id: 'main',
    firstName: document.getElementById('pFirstName').value.trim(),
    lastName: document.getElementById('pLastName').value.trim(),
    birthdate: document.getElementById('pBirthdate').value,
    profession: document.getElementById('pProfession').value.trim(),
    company: document.getElementById('pCompany').value.trim(),
    ausbilder: document.getElementById('pAusbilder').value.trim(),
    startDate: document.getElementById('pStartDate').value,
    endDate: document.getElementById('pEndDate').value,
    weeklyHours: parseInt(document.getElementById('pWeeklyHours').value) || 40,
  };
  await dbPut('profile', data);
  profile = data;
  toast('Stammdaten gespeichert!', 'success');
  renderDashboard();
}

// ===== Dashboard =====
async function renderDashboard() {
  profile = (await dbGet('profile', 'main')) || {};
  const entries = await dbGetAll('entries');
  const hasProfile = profile.firstName || profile.lastName;
  const el = document.getElementById('profileSummary');
  if (hasProfile) {
    el.style.display = 'flex';
    const name = (profile.firstName + ' ' + profile.lastName).trim();
    document.getElementById('summaryName').textContent = name;
    document.getElementById('avatarInitials').textContent = ((profile.firstName||'A')[0] + (profile.lastName||'W')[0]).toUpperCase();
    let det = profile.profession || 'Auszubildende/r';
    if (profile.company) det += ' ¬∑ ' + profile.company;
    if (profile.ausbilder) det += ' ¬∑ Ausbilder: ' + profile.ausbilder;
    document.getElementById('summaryDetails').textContent = det;
  } else { el.style.display = 'none'; }
  const totalDaysBetrieb  = entries.reduce((s,e) => s + (parseFloat(e.daysBetrieb)||0), 0);
  const totalDaysHome     = entries.reduce((s,e) => s + (parseFloat(e.daysHome)||0), 0);
  const totalDaysSchool   = entries.reduce((s,e) => s + (parseFloat(e.daysSchool)||0), 0);
  const totalHoursBetrieb = entries.reduce((s,e) => s + (parseFloat(e.hoursBetrieb)||0), 0);
  const totalHoursSchool  = entries.reduce((s,e) => s + (parseFloat(e.hoursSchool)||0), 0);
  const totalWorkDays = totalDaysBetrieb + totalDaysHome;
  const avgWork   = totalWorkDays   > 0 ? (totalHoursBetrieb / totalWorkDays).toFixed(1)   : '‚Äî';
  const avgSchool = totalDaysSchool > 0 ? (totalHoursSchool  / totalDaysSchool).toFixed(1) : '‚Äî';
  document.getElementById('statTotal').textContent      = entries.length;
  document.getElementById('statOffice').textContent     = totalDaysBetrieb;
  document.getElementById('statHome').textContent       = totalDaysHome;
  document.getElementById('statSchool').textContent     = totalDaysSchool;
  document.getElementById('statAvgWork').textContent    = avgWork;
  document.getElementById('statAvgSchool').textContent  = avgSchool;
  const recent = [...entries].sort((a,b) => (b.year*100+b.kw)-(a.year*100+a.kw)).slice(0,5);
  const c = document.getElementById('recentEntries');
  if (recent.length === 0) {
    c.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>Noch keine Berichte vorhanden.</p><button class="btn btn-primary" onclick="showPage(\'entries\')">Ersten Bericht erstellen</button></div>';
  } else { c.innerHTML = recent.map(e => entryHTML(e)).join(''); }
}

// ===== Entries =====
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function entryHTML(e) {
  const tags = [];
  if (e.daysBetrieb > 0) tags.push('<span class="tag tag-office">&#x1F3E2; '+e.daysBetrieb+'T</span>');
  if (e.daysHome > 0) tags.push('<span class="tag tag-home">&#x1F3E0; '+e.daysHome+'T</span>');
  if (e.daysSchool > 0) tags.push('<span class="tag tag-school">&#x1F393; '+e.daysSchool+'T</span>');
  if (e.daysSick > 0) tags.push('<span class="tag tag-sick">&#x1F912; '+e.daysSick+'T</span>');
  if (e.daysVacation > 0) tags.push('<span class="tag tag-vacation">&#x1F334; '+e.daysVacation+'T</span>');
  const dr = e.dateFrom && e.dateTo ? fmtDate(e.dateFrom) + ' ‚Äì ' + fmtDate(e.dateTo) : '';
  const desc = e.description ? escHtml(e.description.substring(0,90)) + (e.description.length>90?'‚Ä¶':'') : '(keine Beschreibung)';
  const meta = [dr, e.hours ? e.hours+' Std.' : ''].filter(Boolean).join(' ¬∑ ');
  return '<div class="week-item" onclick="openEntryModal('+e.id+')">'
    +'<div class="week-item-left"><div class="week-badge">KW '+e.kw+' / '+e.year+'</div>'
    +'<div><div class="week-item-title">'+desc+'</div>'
    +(meta?'<div class="week-item-meta">'+meta+'</div>':'')
    +'<div class="week-item-tags">'+tags.join('')+'</div></div></div>'
    +'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>';
}
async function renderEntries() {
  const entries = await dbGetAll('entries');
  const q = (document.getElementById('searchInput').value||'').toLowerCase();
  const filtered = entries.filter(e => !q||(e.description||'').toLowerCase().includes(q)||String(e.kw).includes(q)||String(e.year).includes(q))
    .sort((a,b)=>(b.year*100+b.kw)-(a.year*100+a.kw));
  const c = document.getElementById('entriesContainer');
  if (filtered.length === 0) {
    c.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>'+(q?'Keine Berichte gefunden.':'Noch keine Berichte vorhanden.')+'</p>'+(!q?'<button class="btn btn-primary" onclick="openEntryModal(null)">Ersten Bericht erstellen</button>':'')+'</div>';
  } else { c.innerHTML = filtered.map(e => entryHTML(e)).join(''); }
}

// ===== Modal =====
async function openEntryModal(id) {
  currentEditId = id;
  document.getElementById('deleteEntryBtn').style.display = id ? 'inline-flex' : 'none';
  document.getElementById('modalTitle').textContent = id ? 'Bericht bearbeiten' : 'Neuer Bericht';
  if (id) {
    const entries = await dbGetAll('entries');
    const e = entries.find(x => x.id === id);
    if (e) {
      document.getElementById('eKW').value = e.kw||''; document.getElementById('eYear').value = e.year||'';
      document.getElementById('eFrom').value = e.dateFrom||''; document.getElementById('eTo').value = e.dateTo||'';
      document.getElementById('eDescription').value = e.description||'';
      document.getElementById('eHoursBetrieb').value = e.hoursBetrieb != null ? e.hoursBetrieb : (e.hours||'');
      document.getElementById('eHoursSchool').value  = e.hoursSchool  != null ? e.hoursSchool  : '';
      recalcTotalHours();
      document.getElementById('eDaysBetrieb').value = e.daysBetrieb||0; document.getElementById('eDaysHome').value = e.daysHome||0;
      document.getElementById('eDaysSchool').value = e.daysSchool||0; document.getElementById('eDaysSick').value = e.daysSick||0;
      document.getElementById('eDaysVacation').value = e.daysVacation||0;
    }
  } else {
    document.getElementById('eKW').value=''; document.getElementById('eYear').value=new Date().getFullYear();
    document.getElementById('eFrom').value=''; document.getElementById('eTo').value='';
    document.getElementById('eDescription').value='';
    document.getElementById('eHoursBetrieb').value=(profile&&profile.weeklyHours)?profile.weeklyHours:40;
    document.getElementById('eHoursSchool').value='';
    recalcTotalHours();
    document.getElementById('eDaysBetrieb').value=0; document.getElementById('eDaysHome').value=0;
    document.getElementById('eDaysSchool').value=0; document.getElementById('eDaysSick').value=0;
    document.getElementById('eDaysVacation').value=0;
  }
  document.getElementById('entryModal').classList.add('open');
}
function closeEntryModal() { document.getElementById('entryModal').classList.remove('open'); currentEditId = null; }
async function saveEntry() {
  const kw = parseInt(document.getElementById('eKW').value);
  const year = parseInt(document.getElementById('eYear').value);
  if (!kw||kw<1||kw>53) { toast('Bitte eine g√ºltige Kalenderwoche (1‚Äì53) eingeben.','error'); return; }
  if (!year||year<2000) { toast('Bitte ein g√ºltiges Jahr eingeben.','error'); return; }
  const hoursBetrieb = parseFloat(document.getElementById('eHoursBetrieb').value);
  if (!hoursBetrieb || hoursBetrieb <= 0) { toast('Bitte die Stunden im Betrieb / Homeoffice eingeben.','error'); return; }
  const hoursSchool = parseFloat(document.getElementById('eHoursSchool').value) || 0;
  const totalHours  = parseFloat(document.getElementById('eHours').value) || (hoursBetrieb + hoursSchool);
  const data = {
    kw, year,
    dateFrom: document.getElementById('eFrom').value, dateTo: document.getElementById('eTo').value,
    description: document.getElementById('eDescription').value.trim(),
    hoursBetrieb,
    hoursSchool,
    hours: totalHours,
    daysBetrieb: parseFloat(document.getElementById('eDaysBetrieb').value)||0,
    daysHome: parseFloat(document.getElementById('eDaysHome').value)||0,
    daysSchool: parseFloat(document.getElementById('eDaysSchool').value)||0,
    daysSick: parseFloat(document.getElementById('eDaysSick').value)||0,
    daysVacation: parseFloat(document.getElementById('eDaysVacation').value)||0,
    updatedAt: new Date().toISOString(),
  };
  if (currentEditId) data.id = currentEditId;
  await dbPut('entries', data);
  closeEntryModal();
  toast(currentEditId ? 'Bericht aktualisiert!' : 'Bericht gespeichert!', 'success');
  renderEntries(); renderDashboard();
}
async function deleteCurrentEntry() {
  const ok = await showConfirm('Bericht l√∂schen?','Dieser Bericht wird unwiderruflich gel√∂scht.','üóëÔ∏è','L√∂schen','btn-danger');
  if (!ok) return;
  await dbDelete('entries', currentEditId);
  closeEntryModal(); toast('Bericht gel√∂scht.',''); renderEntries(); renderDashboard();
}

// ===== Stunden auto-sum =====
function recalcTotalHours() {
  const b = parseFloat(document.getElementById('eHoursBetrieb').value) || 0;
  const s = parseFloat(document.getElementById('eHoursSchool').value)  || 0;
  document.getElementById('eHours').value = (b + s) > 0 ? (b + s) : '';
}

// ===== Auto KW =====
function autoFillKW() {
  const now = new Date(); const kw = getISOWeek(now); const year = now.getFullYear();
  currentEditId = null;
  document.getElementById('deleteEntryBtn').style.display = 'none';
  document.getElementById('modalTitle').textContent = 'Neuer Bericht';
  document.getElementById('eKW').value = kw; document.getElementById('eYear').value = year;
  const monday = getMondayOfKW(kw, year);
  const friday = new Date(monday); friday.setUTCDate(friday.getUTCDate()+4);
  document.getElementById('eFrom').value = toInputDate(monday); document.getElementById('eTo').value = toInputDate(friday);
  document.getElementById('eDescription').value = '';
  document.getElementById('eHoursBetrieb').value = (profile&&profile.weeklyHours)?profile.weeklyHours:40;
  document.getElementById('eHoursSchool').value = '';
  recalcTotalHours();
  document.getElementById('eDaysBetrieb').value=0; document.getElementById('eDaysHome').value=0;
  document.getElementById('eDaysSchool').value=0; document.getElementById('eDaysSick').value=0; document.getElementById('eDaysVacation').value=0;
  document.getElementById('entryModal').classList.add('open');
}

// ===== Export JSON =====
async function exportData() {
  const p = (await dbGet('profile','main'))||{};
  const entries = await dbGetAll('entries');
  const blob = new Blob([JSON.stringify({version:1,exportedAt:new Date().toISOString(),profile:p,entries},null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  a.download='berichtsheft_'+new Date().toISOString().split('T')[0]+'.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('Export erfolgreich! ('+entries.length+' Berichte)','success');
}

// ===== Import JSON =====
async function importData(event) {
  const file = event.target.files[0]; if (!file) return; event.target.value='';
  const ok = await showConfirm('Daten importieren?','Alle vorhandenen Daten werden √ºberschrieben. Fortfahren?','üì•','Ja, importieren','btn-primary');
  if (!ok) return;
  try {
    const data = JSON.parse(await file.text());
    if (!data.version||!Array.isArray(data.entries)) throw new Error('Ung√ºltiges Format');
    await dbClear('entries'); await dbClear('profile');
    if (data.profile) await dbPut('profile',{id:'main',...data.profile});
    for (const entry of data.entries) { const {id,...rest}=entry; await dbPut('entries',rest); }
    profile = (await dbGet('profile','main'))||{};
    toast('Import erfolgreich! '+data.entries.length+' Berichte importiert.','success');
    renderDashboard(); renderEntries();
  } catch(e) { toast('Fehler beim Importieren: '+e.message,'error'); }
}

// ===== PDF: load scripts =====
function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector('script[src="'+src+'"]')) { resolve(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = resolve;
    s.onerror = () => reject(new Error('Skript nicht ladbar: '+src));
    document.head.appendChild(s);
  });
}

async function loadPdfLibs() {
  await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
  await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
}

async function renderPageToCanvas(html) {
  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'position:fixed;left:-9999px;top:0;width:794px;height:1123px;border:none;visibility:hidden;';
  document.body.appendChild(iframe);
  const iDoc = iframe.contentDocument || iframe.contentWindow.document;
  iDoc.open();
  iDoc.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{box-sizing:border-box;margin:0;padding:0;}body{background:#fff;}</style></head><body>' + html + '</body></html>');
  iDoc.close();
  await new Promise(r => setTimeout(r, 320));
  const canvas = await html2canvas(iDoc.body.firstElementChild, {
    scale: 2, useCORS: true, backgroundColor: '#ffffff',
    width: 794, windowWidth: 794, logging: false,
  });
  document.body.removeChild(iframe);
  return canvas;
}

// ===== PDF progress helpers =====
let _pdfMinimized = false;
let _progressToastEl = null;
let _pdfAbortController = null;   // AbortController for cancellation
let _pdfRunning = false;           // true while a PDF is being generated

function pdfShowModal(total) {
  _pdfMinimized = false;
  const m = document.getElementById('pdfProgressModal');
  m.style.display = 'flex';
  document.getElementById('pdfModalTitle').textContent = 'PDF wird erstellt‚Ä¶';
  document.getElementById('pdfModalStatus').textContent = 'Seite 1 von ' + total;
  document.getElementById('pdfProgressBar').style.width = '0%';
}

function pdfUpdateProgress(current, total) {
  const pct = Math.round((current / total) * 100);
  if (!_pdfMinimized) {
    document.getElementById('pdfModalStatus').textContent = 'Seite ' + current + ' von ' + total;
    document.getElementById('pdfProgressBar').style.width = pct + '%';
  }
  if (_progressToastEl) {
    _progressToastEl.querySelector('.progress-toast-bar').style.width = pct + '%';
    _progressToastEl.querySelector('.pt-status').textContent = 'Seite ' + current + ' von ' + total;
  }
}

function pdfMinimize() {
  _pdfMinimized = true;
  document.getElementById('pdfProgressModal').style.display = 'none';
  // Create (or reuse) persistent progress toast with stop button
  if (_progressToastEl) return;
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = 'progress-toast';
  el.innerHTML =
    `<div class="progress-toast-title" style="justify-content:space-between;">
       <span>üìÑ PDF wird generiert‚Ä¶</span>
       <button onclick="pdfAbort()" style="background:none;border:none;color:#ff6b6b;cursor:pointer;font-size:18px;line-height:1;padding:0;" title="Abbrechen">‚úï</button>
     </div>
     <div class="pt-status" style="font-size:11px;color:#aaa;margin-bottom:7px;">Seite 1 von ‚Ä¶</div>
     <div class="progress-toast-bar-wrap"><div class="progress-toast-bar" style="width:0%"></div></div>`;
  container.appendChild(el);
  _progressToastEl = el;
}

function pdfAbort() {
  if (_pdfAbortController) _pdfAbortController.abort();
}

function pdfHideProgress() {
  document.getElementById('pdfProgressModal').style.display = 'none';
  if (_progressToastEl) { _progressToastEl.remove(); _progressToastEl = null; }
  _pdfMinimized = false;
  _pdfRunning = false;
  _pdfAbortController = null;
}

// ===== PDF: main =====
async function printReports(filtered) {
  // If a PDF is already being generated, ask user whether to stop it
  if (_pdfRunning) {
    const ok = await showConfirm(
      'Aktive Generierung l√§uft',
      'Eine PDF-Generierung ist bereits aktiv. Soll sie abgebrochen und eine neue gestartet werden?',
      '‚ö†Ô∏è', 'Ja, neu starten', 'btn-danger'
    );
    if (!ok) return;
    pdfAbort();
    // Give abort a tick to propagate before starting fresh
    await new Promise(r => setTimeout(r, 80));
  }

  profile = (await dbGet('profile','main'))||{};
  let entries = await dbGetAll('entries');
  if (filtered) {
    const from = parseInt(document.getElementById('printFrom').value)||1;
    const to   = parseInt(document.getElementById('printTo').value)||53;
    const year = parseInt(document.getElementById('printYear').value)||0;
    entries = entries.filter(e => { if(year&&e.year!==year) return false; return e.kw>=from&&e.kw<=to; });
  }
  entries.sort((a,b)=>(a.year*100+a.kw)-(b.year*100+b.kw));
  if (entries.length===0) { toast('Keine Berichte f√ºr diesen Zeitraum gefunden.','error'); return; }

  try { await loadPdfLibs(); } catch(e) { toast('Bibliothek nicht ladbar. Internetverbindung pr√ºfen.','error'); return; }

  // Create a fresh abort controller for this run
  _pdfAbortController = new AbortController();
  const signal = _pdfAbortController.signal;
  _pdfRunning = true;

  const fullName = ((profile.firstName||'')+ ' '+(profile.lastName||'')).trim()||'Alexander Wiese';
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });

  try {
    if (currentPrintMode === 'full') {
      // ---- DETAILED MODE: one entry per page ----
      const total = entries.length;
      pdfShowModal(total);
      for (let i = 0; i < total; i++) {
        if (signal.aborted) throw new DOMException('Aborted', 'AbortError');
        pdfUpdateProgress(i + 1, total);
        const html = buildPageDetailed(entries[i], profile, fullName, i+1, total);
        const canvas = await renderPageToCanvas(html);
        if (i > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/jpeg',0.97), 'JPEG', 0, 0, 210, 297);
      }
    } else {
      // ---- COMPACT MODE: N entries per page ----
      const perPage = parseInt(document.getElementById('weeksPerPage').value)||6;
      const chunks = [];
      for (let i=0; i<entries.length; i+=perPage) chunks.push(entries.slice(i, i+perPage));
      const total = chunks.length;
      pdfShowModal(total);
      for (let ci=0; ci<total; ci++) {
        if (signal.aborted) throw new DOMException('Aborted', 'AbortError');
        pdfUpdateProgress(ci + 1, total);
        const startIndex = ci * perPage;
        const html = buildPageCompact(chunks[ci], profile, fullName, ci+1, total, startIndex);
        const canvas = await renderPageToCanvas(html);
        if (ci > 0) doc.addPage();
        doc.addImage(canvas.toDataURL('image/jpeg',0.97), 'JPEG', 0, 0, 210, 297);
      }
    }
  } catch (err) {
    pdfHideProgress();
    if (err.name === 'AbortError') {
      toast('PDF-Generierung abgebrochen.', '');
    } else {
      toast('Fehler bei der PDF-Generierung: ' + err.message, 'error');
    }
    return;
  }

  pdfHideProgress();
  const suffix = currentPrintMode === 'compact' ? '_kompakt' : '_detailliert';
  doc.save('Berichtsheft_' + fullName.replace(/ /g,'_') + suffix + '_' + new Date().toISOString().split('T')[0] + '.pdf');
  toast('PDF heruntergeladen! (' + entries.length + ' Berichte)', 'success');
}

// ===== PDF: detailed page template =====
function buildPageDetailed(e, p, fullName, pageNum, total) {
  const dr = (e.dateFrom&&e.dateTo)?fmtDate(e.dateFrom)+' ‚Äì '+fmtDate(e.dateTo):'‚Äì';
  const bd = p.birthdate?fmtDate(p.birthdate):'‚Äì';
  const desc = escHtml(e.description||'').replace(/\n/g,'<br>');
  const td1 = 'padding:5px 8px;border:1px solid #aaa;font-weight:bold;background:#f0f0f0;width:22%;vertical-align:top;font-size:11px;';
  const td2 = 'padding:5px 8px;border:1px solid #aaa;width:28%;vertical-align:top;font-size:11px;';
  const th  = 'background:#e0e0e0;border:1px solid #aaa;padding:6px 4px;text-align:center;font-size:11px;';
  const td  = 'border:1px solid #aaa;padding:7px 4px;text-align:center;font-size:12px;';
  return `<div style="background:#fff;width:794px;min-height:1123px;padding:52px 64px 70px;font-family:'Times New Roman',serif;font-size:13px;color:#000;box-sizing:border-box;position:relative;">
  <div style="border-bottom:1.5px solid #000;padding-bottom:10px;margin-bottom:14px;">
    <div style="font-size:20px;font-weight:bold;">Ausbildungsnachweis</div>
    <div style="font-size:12px;color:#555;margin-top:3px;">gem√§√ü ¬ß 43 Berufsbildungsgesetz (BBiG) ‚Äì Wochenbericht</div>
  </div>
  <table style="width:100%;border-collapse:collapse;margin-bottom:12px;">
    <tr><td style="${td1}">Name Auszubildende/r</td><td style="${td2}">${fullName}</td><td style="${td1}">Geburtsdatum</td><td style="${td2}">${bd}</td></tr>
    <tr><td style="${td1}">Ausbildungsbetrieb</td><td style="${td2}">${escHtml(p.company||'‚Äì')}</td><td style="${td1}">Ausbilder/in</td><td style="${td2}">${escHtml(p.ausbilder||'‚Äì')}</td></tr>
    <tr><td style="${td1}">Ausbildungsberuf</td><td style="${td2}">${escHtml(p.profession||'‚Äì')}</td><td style="${td1}">Ausbildungsdauer</td><td style="${td2}">${p.startDate?fmtDate(p.startDate):'‚Äì'} ‚Äì ${p.endDate?fmtDate(p.endDate):'‚Äì'}</td></tr>
    <tr><td style="${td1}">Berichtszeitraum</td><td style="${td2}">${dr}</td><td style="${td1}">Kalenderwoche</td><td style="${td2}"><strong>KW ${e.kw} / ${e.year}</strong></td></tr>
  </table>
  <div style="font-size:11px;font-weight:bold;margin-bottom:5px;">Beschreibung der T√§tigkeiten:</div>
  <div style="border:1px solid #aaa;padding:10px;min-height:175px;font-size:12px;line-height:1.6;word-break:break-word;margin-bottom:12px;">${desc}</div>
  <table style="width:100%;border-collapse:collapse;margin-bottom:12px;">
    <thead><tr>
      <th style="${th}">Betrieb<br>(Tage)</th><th style="${th}">Homeoffice<br>(Tage)</th><th style="${th}">Berufsschule<br>(Tage)</th><th style="${th}">Krank<br>(Tage)</th><th style="${th}">Urlaub<br>(Tage)</th><th style="${th}">Stunden<br>Betrieb/HO</th>${(e.hoursSchool||0)>0?`<th style="${th}">Stunden<br>Schule</th><th style="${th}">Stunden<br>gesamt</th>`:`<th style="${th}">Stunden<br>gesamt</th>`}
    </tr></thead>
    <tbody><tr>
      <td style="${td}">${e.daysBetrieb||0}</td><td style="${td}">${e.daysHome||0}</td><td style="${td}">${e.daysSchool||0}</td><td style="${td}">${e.daysSick||0}</td><td style="${td}">${e.daysVacation||0}</td><td style="${td}">${e.hoursBetrieb||0}</td>${(e.hoursSchool||0)>0?`<td style="${td}">${e.hoursSchool}</td><td style="${td}"><strong>${e.hours||0}</strong></td>`:`<td style="${td}"><strong>${e.hoursBetrieb||0}</strong></td>`}
    </tr></tbody>
  </table>
  <div style="border:1px solid #000;padding:11px;font-size:11px;line-height:1.6;background:#fafafa;margin-bottom:22px;">
    <strong>Best√§tigung gem√§√ü ¬ß 43 BBiG:</strong><br>
    Hiermit best√§tigen wir, dass ${fullName} die gem√§√ü ¬ß 43 Berufsbildungsgesetz erforderlichen Ausbildungsnachweise eigenh√§ndig, ohne fremde Hilfe und vollst√§ndig erstellt hat. Diese Erkl√§rung dient der Vorlage beim zust√§ndigen Pr√ºfungsausschuss.
  </div>
  <div style="display:flex;justify-content:space-between;">
    <div style="width:44%;"><div style="border-bottom:1px solid #000;height:42px;margin-bottom:5px;"></div><div style="font-size:10px;color:#555;">Datum, Unterschrift Auszubildende/r</div><div style="font-size:10px;color:#222;margin-top:2px;">${fullName}</div></div>
    <div style="width:44%;"><div style="border-bottom:1px solid #000;height:42px;margin-bottom:5px;"></div><div style="font-size:10px;color:#555;">Datum, Unterschrift Ausbilder/in</div><div style="font-size:10px;color:#222;margin-top:2px;">${escHtml(p.ausbilder||'‚Äì')}</div></div>
  </div>
  <div style="position:absolute;bottom:22px;left:64px;right:64px;text-align:center;font-size:9px;color:#999;border-top:1px solid #ddd;padding-top:5px;">
    ${escHtml(p.company||'')} &nbsp;¬∑&nbsp; KW ${e.kw} / ${e.year} &nbsp;¬∑&nbsp; Seite ${pageNum} von ${total}
  </div>
</div>`;
}

// ===== PDF: compact page template ‚Äî official ¬ß43 BBiG, multiple weeks per page =====
function buildPageCompact(entries, p, fullName, pageNum, totalPages, startIndex) {
  const bd = p.birthdate ? fmtDate(p.birthdate) : '‚Äì';
  const periodStr = entries.length
    ? 'KW ' + entries[0].kw + ' ‚Äì KW ' + entries[entries.length-1].kw + ' / ' + entries[entries.length-1].year
    : '';

  // Check if ANY entry on this page has school hours
  const hasSchool = entries.some(e => (parseFloat(e.hoursSchool)||0) > 0);

  const thS  = 'background:#1f3a5f;color:#fff;border:1px solid #1a3354;padding:4px 3px;text-align:center;font-size:9px;white-space:nowrap;font-weight:700;';
  const thSL = 'background:#1f3a5f;color:#fff;border:1px solid #1a3354;padding:4px 6px;text-align:left;font-size:9px;font-weight:700;';
  const td1s = 'padding:3px 7px;border:1px solid #ccc;font-weight:bold;background:#f0f2f5;font-size:9px;white-space:nowrap;vertical-align:middle;';
  const td2s = 'padding:3px 7px;border:1px solid #ccc;font-size:9px;vertical-align:middle;';

  // Build one "week block" = header row (KW/meta) + attendance row + description
  const weekBlocks = entries.map((e, i) => {
    const dr = (e.dateFrom && e.dateTo) ? fmtDate(e.dateFrom) + ' ‚Äì ' + fmtDate(e.dateTo) : '‚Äì';
    const desc = e.description ? escHtml(e.description).replace(/\n/g, '<br>') : '‚Äì';
    const rowBg = i % 2 === 0 ? '#fff' : '#f7f9fc';
    const rowBgD = i % 2 === 0 ? '#fafcff' : '#f0f4f9';
    const workHours = (e.hoursBetrieb || 0);
    const schoolHours = (e.hoursSchool || 0);
    const totalHours = (e.hours || workHours);

    const hoursCell = hasSchool
      ? `<td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};">${workHours}</td>
         <td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};">${schoolHours > 0 ? schoolHours : '‚Äì'}</td>
         <td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};font-weight:700;">${totalHours}</td>`
      : `<td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};font-weight:700;">${workHours}</td>`;

    const hoursHeader = hasSchool
      ? `<th style="${thS}">Stunden<br>Arbeit</th><th style="${thS}">Stunden<br>Schule</th><th style="${thS}">Stunden<br>gesamt</th>`
      : `<th style="${thS}">Stunden</th>`;

    return `
    <!-- Week ${e.kw}/${e.year} -->
    <div style="margin-bottom:6px;border:1px solid #c8d0dc;border-radius:3px;overflow:hidden;page-break-inside:avoid;">
      <!-- KW header bar -->
      <div style="background:#1f3a5f;color:#fff;display:flex;align-items:center;padding:4px 8px;gap:12px;">
        <span style="font-size:11px;font-weight:700;white-space:nowrap;">KW ${e.kw} / ${e.year}</span>
        <span style="font-size:9px;opacity:0.85;">${dr}</span>
        <span style="margin-left:auto;font-size:9px;opacity:0.7;">Ausbildungswoche ${startIndex + i + 1}</span>
      </div>
      <!-- Attendance table -->
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr>
            <th style="${thS}">Betrieb<br>Tage</th>
            <th style="${thS}">Homeoffice<br>Tage</th>
            <th style="${thS}">Schule<br>Tage</th>
            <th style="${thS}">Krank<br>Tage</th>
            <th style="${thS}">Urlaub<br>Tage</th>
            ${hoursHeader}
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};">${e.daysBetrieb||0}</td>
            <td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};">${e.daysHome||0}</td>
            <td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};">${e.daysSchool||0}</td>
            <td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};">${e.daysSick||0}</td>
            <td style="border:1px solid #c8c8c8;padding:3px 4px;text-align:center;font-size:8.5px;background:${rowBg};">${e.daysVacation||0}</td>
            ${hoursCell}
          </tr>
        </tbody>
      </table>
      <!-- Description -->
      <div style="padding:5px 8px;font-size:8.5px;line-height:1.5;color:#111;background:${rowBgD};word-break:break-word;">
        ${desc}
      </div>
    </div>`;
  }).join('');

  return `<div style="background:#fff;width:794px;min-height:1123px;padding:30px 44px 56px;font-family:'Arial',sans-serif;font-size:10px;color:#000;box-sizing:border-box;position:relative;">

  <!-- Page header -->
  <div style="text-align:center;border-bottom:2.5px solid #1f3a5f;padding-bottom:7px;margin-bottom:9px;">
    <div style="font-size:15px;font-weight:bold;color:#1f3a5f;">Ausbildungsnachweis gem√§√ü ¬ß 43 BBiG</div>
    <div style="font-size:9px;color:#666;margin-top:2px;">${periodStr} ¬∑ ${entries.length} Woche(n) ¬∑ Seite ${pageNum} von ${totalPages}</div>
  </div>

  <!-- Profile info compact -->
  <table style="width:100%;border-collapse:collapse;margin-bottom:9px;font-size:9px;">
    <tr>
      <td style="${td1s}width:18%;">Auszubildende/r</td><td style="${td2s}width:28%;">${fullName}</td>
      <td style="${td1s}width:15%;">Geb.-datum</td><td style="${td2s}width:17%;">${bd}</td>
      <td style="${td1s}width:10%;">Ausbilder</td><td style="${td2s}">${escHtml(p.ausbilder||'‚Äì')}</td>
    </tr>
    <tr>
      <td style="${td1s}">Betrieb</td><td style="${td2s}">${escHtml(p.company||'‚Äì')}</td>
      <td style="${td1s}">Beruf</td><td style="${td2s}" colspan="3">${escHtml(p.profession||'‚Äì')} &nbsp;¬∑&nbsp; ${p.startDate?fmtDate(p.startDate):'‚Äì'} ‚Äì ${p.endDate?fmtDate(p.endDate):'‚Äì'}</td>
    </tr>
  </table>

  <!-- Week blocks -->
  ${weekBlocks}

  <!-- ¬ß43 confirmation -->
  <div style="border:1px solid #888;padding:6px 9px;font-size:8.5px;line-height:1.55;background:#fafafa;margin-top:8px;margin-bottom:10px;">
    <strong>Best√§tigung gem√§√ü ¬ß 43 BBiG:</strong> Hiermit best√§tigen wir, dass ${fullName} die gem√§√ü ¬ß 43 Berufsbildungsgesetz erforderlichen Ausbildungsnachweise eigenh√§ndig, ohne fremde Hilfe und vollst√§ndig erstellt hat. Diese Erkl√§rung dient der Vorlage beim zust√§ndigen Pr√ºfungsausschuss.
  </div>

  <!-- Signatures -->
  <div style="display:flex;justify-content:space-between;">
    <div style="width:44%;">
      <div style="border-bottom:1px solid #000;height:30px;margin-bottom:3px;"></div>
      <div style="font-size:8.5px;color:#555;">Datum, Unterschrift Auszubildende/r</div>
      <div style="font-size:8.5px;color:#222;margin-top:1px;">${fullName}</div>
    </div>
    <div style="width:44%;">
      <div style="border-bottom:1px solid #000;height:30px;margin-bottom:3px;"></div>
      <div style="font-size:8.5px;color:#555;">Datum, Unterschrift Ausbilder/in</div>
      <div style="font-size:8.5px;color:#222;margin-top:1px;">${escHtml(p.ausbilder||'‚Äì')}</div>
    </div>
  </div>

  <!-- Footer -->
  <div style="position:absolute;bottom:16px;left:44px;right:44px;text-align:center;font-size:7.5px;color:#aaa;border-top:1px solid #e8e8e8;padding-top:4px;">
    ${escHtml(p.company||'')} &nbsp;¬∑&nbsp; ${periodStr} &nbsp;¬∑&nbsp; Seite ${pageNum} von ${totalPages} &nbsp;¬∑&nbsp; Ausbildungsnachweis gem. ¬ß 43 BBiG ‚Äì geeignet als offizieller Abgabenachweis beim Pr√ºfungsausschuss
  </div>
</div>`;
}
// ===== Close modal on outside click =====
document.getElementById('entryModal').addEventListener('click', function(e) { if (e.target===this) closeEntryModal(); });

// ===== Init =====
initDB().then(async () => {
  profile = (await dbGet('profile','main'))||{};
  renderDashboard();
}).catch(err => toast('Datenbankfehler: '+err.message,'error'));
</script>
</body>
</html>
